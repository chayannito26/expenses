<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Expense Tracker</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Tailwind's gray-50 */
        }
        /* Style for the scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* gray-100 */
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* gray-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* gray-400 */
        }
        /* Simple fade-in animation for modal */
        .modal-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Project Expense Tracker</h1>
            <p class="text-gray-600 mt-1">A central place to monitor all project-related expenditures.</p>
        </header>

        <!-- Controls: Search and Filters -->
        <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Search Bar -->
                <div class="lg:col-span-1">
                    <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                    <input type="text" id="search" placeholder="Search by purpose, comments..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                </div>

                <!-- Filter by Type -->
                <div>
                    <label for="filter-type" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <select id="filter-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <option value="all">All Categories</option>
                        <!-- Options will be populated by JS -->
                    </select>
                </div>

                <!-- Filter by Person -->
                <div>
                    <label for="filter-person" class="block text-sm font-medium text-gray-700 mb-1">Person</label>
                    <select id="filter-person" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <option value="all">All People</option>
                        <!-- Options will be populated by JS -->
                    </select>
                </div>

                <!-- Date Range Filter -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                    <div class="flex space-x-2">
                        <input type="date" id="filter-date-start" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <input type="date" id="filter-date-end" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                    </div>
                </div>
            </div>
        </div>

        <!-- Expense Table / List -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-3">Purpose / Details</th>
                            <th scope="col" class="px-6 py-3 hidden md:table-cell">People</th>
                            <th scope="col" class="px-6 py-3 hidden lg:table-cell">Date</th>
                            <th scope="col" class="px-6 py-3 hidden sm:table-cell">Category</th>
                            <th scope="col" class="px-6 py-3 text-right">Amount</th>
                            <th scope="col" class="px-6 py-3 text-center">Receipts</th>
                        </tr>
                    </thead>
                    <tbody id="expense-table-body">
                        <!-- Rows will be populated by JS -->
                         <tr>
                            <td colspan="6" class="text-center p-8 text-gray-500">
                                Loading expenses...
                            </td>
                        </tr>
                    </tbody>
                    <tfoot class="bg-gray-100 font-semibold text-gray-900">
                        <tr>
                            <td class="px-6 py-4 text-right" colspan="4">Total Spending</td>
                            <td id="total-spending" class="px-6 py-4 text-right">à§³0</td>
                            <td class="px-6 py-4"></td>
                        </tr>
                    </tfoot>
                </table>
                 <div id="no-results" class="text-center py-12 text-gray-500 hidden">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                      <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No expenses found</h3>
                    <p class="mt-1 text-sm text-gray-500">Try adjusting your search or filter criteria.</p>
                  </div>
            </div>
        </div>
    </div>

    <!-- Receipt Viewer Modal -->
    <div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 modal-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-900">Receipts</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-800 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="receipt-images-container" class="grid grid-cols-1 sm:grid-cols-1 gap-6">
                <!-- Receipt images will be populated by JS -->
            </div>
        </div>
    </div>

    <!-- Main JavaScript Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL STATE ---
            let expenses = [];

            // --- BACKUP DATA ---
            const backupExpenses = [
                {
                    "id": 1, "purpose": "Team Lunch (Backup Data)", "amount": 151, "date": "2025-08-15", "type": "Food",
                    "comments": "Lunch meeting with the design team to discuss project milestones.",
                    "persons": ["Alice Johnson", "Charlie Brown"],
                    "receipts": [
                        { "url": "https://placehold.co/600x400/e2e8f0/475569?text=Receipt+1", "description": "Main course and drinks" },
                        { "url": "https://placehold.co/600x400/e2e8f0/475569?text=Receipt+2", "description": "Desserts and coffee" }
                    ]
                },
                {
                    "id": 2, "purpose": "Client Transport", "amount": 66, "date": "2025-08-14", "type": "Transport",
                    "comments": "Uber ride for client from airport to hotel.",
                    "persons": ["Bob Williams"],
                    "receipts": [
                        { "url": "https://placehold.co/600x400/e2e8f0/475569?text=Receipt+3", "description": "Uber trip receipt" }
                    ]
                },
                {
                    "id": 3, "purpose": "New Keyboard", "amount": 120, "date": "2025-08-12", "type": "Equipment",
                    "comments": "Mechanical keyboard for the lead developer.",
                    "persons": ["Charlie Brown"],
                    "receipts": []
                },
                {
                    "id": 4, "purpose": "Project Blueprints", "amount": 250, "date": "2025-08-10", "type": "Printing",
                    "comments": "Large format printing of architectural blueprints.",
                    "persons": ["Alice Johnson"],
                    "receipts": []
                },
                {
                    "id": 5, "purpose": "Software License", "amount": 300, "date": "2025-08-08", "type": "Software",
                    "comments": "Annual subscription for design software.",
                    "persons": ["David Miller"],
                    "receipts": []
                }
            ];

            // --- DOM ELEMENTS ---
            const tableBody = document.getElementById('expense-table-body');
            const totalSpendingEl = document.getElementById('total-spending');
            const searchInput = document.getElementById('search');
            const typeFilter = document.getElementById('filter-type');
            const personFilter = document.getElementById('filter-person');
            const dateStartFilter = document.getElementById('filter-date-start');
            const dateEndFilter = document.getElementById('filter-date-end');
            const modal = document.getElementById('receipt-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const receiptImagesContainer = document.getElementById('receipt-images-container');
            const noResultsDiv = document.getElementById('no-results');

            /**
             * Fetches expense data from the external JSON file, with a fallback.
             */
            async function fetchExpenses() {
                try {
                    const response = await fetch('expenses.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    const data = await response.json();
                    expenses = data;
                    console.log("Successfully loaded expenses from expenses.json");
                    initializeApp();
                } catch (error) {
                    console.warn("Could not load expenses.json. Using backup data.", error);
                    expenses = backupExpenses;
                    initializeApp();
                }
            }

            /**
             * Initializes the application after data is ready.
             */
            function initializeApp() {
                // Populate person filter
                const people = [...new Set(expenses.flatMap(e => e.persons))].sort();
                people.forEach(person => {
                    const option = document.createElement('option');
                    option.value = person;
                    option.textContent = person;
                    personFilter.appendChild(option);
                });

                // Populate category filter dynamically
                const categories = [...new Set(expenses.map(e => e.type))].sort();
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    typeFilter.appendChild(option);
                });

                // Initial render
                renderTable(expenses);

                // Event Listeners
                [searchInput, typeFilter, personFilter, dateStartFilter, dateEndFilter].forEach(el => {
                    el.addEventListener('input', applyFilters);
                    el.addEventListener('change', applyFilters);
                });

                closeModalBtn.addEventListener('click', closeModal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });
            }

            /**
             * Applies all active filters and re-renders the table.
             */
            function applyFilters() {
                let filteredExpenses = [...expenses];
                const searchTerm = searchInput.value.toLowerCase().trim();
                const type = typeFilter.value;
                const person = personFilter.value;
                const startDate = dateStartFilter.value;
                const endDate = dateEndFilter.value;

                if (searchTerm) {
                    filteredExpenses = filteredExpenses.filter(e =>
                        e.purpose.toLowerCase().includes(searchTerm) ||
                        e.comments.toLowerCase().includes(searchTerm)
                    );
                }
                if (type !== 'all') {
                    filteredExpenses = filteredExpenses.filter(e => e.type === type);
                }
                if (person !== 'all') {
                    filteredExpenses = filteredExpenses.filter(e => e.persons.includes(person));
                }
                if (startDate) {
                    filteredExpenses = filteredExpenses.filter(e => e.date >= startDate);
                }
                if (endDate) {
                    filteredExpenses = filteredExpenses.filter(e => e.date <= endDate);
                }

                renderTable(filteredExpenses);
            }

            /**
             * Renders the expense data into the table.
             */
            function renderTable(data) {
                tableBody.innerHTML = '';

                if (data.length === 0) {
                    noResultsDiv.classList.remove('hidden');
                    totalSpendingEl.textContent = formatCurrency(0);
                    return;
                }

                noResultsDiv.classList.add('hidden');

                let total = 0;
                data.forEach(expense => {
                    total += expense.amount;
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50';

                    const badgeClass = getCategoryColor(expense.type);

                    row.innerHTML = `
                        <td class="px-6 py-4">
                            <div class="font-semibold text-gray-900">${expense.purpose}</div>
                            <div class="text-xs text-gray-500">${expense.comments}</div>
                            <div class="mt-2 text-xs text-gray-500 md:hidden">
                                <span>${expense.persons.join(', ')}</span> &bull; <span>${formatDate(expense.date)}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 hidden md:table-cell">${expense.persons.join(', ')}</td>
                        <td class="px-6 py-4 hidden lg:table-cell">${formatDate(expense.date)}</td>
                        <td class="px-6 py-4 hidden sm:table-cell">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${badgeClass}">
                                ${expense.type}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right font-medium text-gray-900">${formatCurrency(expense.amount)}</td>
                        <td class="px-6 py-4 text-center">
                            ${expense.receipts.length > 0 ? `
                            <button data-receipts='${JSON.stringify(expense.receipts)}' class="view-receipt-btn font-medium text-indigo-600 hover:text-indigo-800 transition">
                                View (${expense.receipts.length})
                            </button>
                            ` : `<span class="text-gray-400 text-xs">None</span>`}
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                totalSpendingEl.textContent = formatCurrency(total);

                document.querySelectorAll('.view-receipt-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const receipts = JSON.parse(e.currentTarget.dataset.receipts);
                        openModal(receipts);
                    });
                });
            }

            /**
             * Opens and populates the receipt modal with descriptions.
             */
            function openModal(receipts) {
                receiptImagesContainer.innerHTML = '';
                receipts.forEach((receipt, index) => {
                    const receiptEl = document.createElement('div');
                    receiptEl.className = 'group relative text-center';
                    receiptEl.innerHTML = `
                        <div class="relative inline-block">
                            <img src="${receipt.url}" alt="Receipt ${index + 1}" class="rounded-lg w-full h-auto object-cover max-w-xs mx-auto" onerror="this.onerror=null;this.src='https://placehold.co/600x400/fecaca/b91c1c?text=Image+Error';">
                            <a href="${receipt.url}" download="receipt-${index + 1}.jpg" class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-xs px-3 py-1.5 rounded-full hover:bg-opacity-75 transition opacity-0 group-hover:opacity-100 flex items-center">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                Download
                            </a>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">${receipt.description || 'No description'}</p>
                    `;
                    receiptImagesContainer.appendChild(receiptEl);
                });
                modal.classList.remove('hidden');
            }

            function closeModal() {
                modal.classList.add('hidden');
            }

            /**
             * Dynamically assigns a color badge to a category.
             * @param {string} category - The category name.
             * @returns {string} Tailwind CSS classes for the badge.
             */
            function getCategoryColor(category) {
                const colors = [
                    "bg-blue-100 text-blue-800", "bg-green-100 text-green-800",
                    "bg-yellow-100 text-yellow-800", "bg-purple-100 text-purple-800",
                    "bg-pink-100 text-pink-800", "bg-indigo-100 text-indigo-800",
                    "bg-red-100 text-red-800", "bg-sky-100 text-sky-800"
                ];
                let hash = 0;
                for (let i = 0; i < category.length; i++) {
                    hash = category.charCodeAt(i) + ((hash << 5) - hash);
                }
                const index = Math.abs(hash % colors.length);
                return colors[index];
            }

            /**
             * Formats a number as BDT currency, rounded to the nearest whole number.
             */
            function formatCurrency(amount) {
                const roundedAmount = Math.round(amount);
                return new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'BDT',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                }).format(roundedAmount).replace('BDT', 'à§³');
            }

            function formatDate(dateString) {
                const date = new Date(dateString + 'T00:00:00');
                return new Intl.DateTimeFormat('en-GB', { month: 'short', day: 'numeric', year: 'numeric' }).format(date);
            }

            // --- START THE APP ---
            fetchExpenses();
        });
    </script>

</body>
</html>
