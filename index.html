<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chayannito 26 Expense Tracker</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Add Flatpickr CSS/JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Tailwind's gray-50 */
        }
        /* Style for the scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; /* gray-100 */
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* gray-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* gray-400 */
        }
        /* Simple fade-in animation for modal */
        .modal-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Chayannito 26 Expense Tracker</h1>
            <p class="text-gray-600 mt-1">A central place to monitor all rag day related expenditures.</p>
        </header>

        <!-- Controls: Search and Filters -->
        <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                <!-- Search Bar -->
                <div class="lg:col-span-1">
                    <label for="search" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                    <input type="text" id="search" placeholder="Search by purpose, comments..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                </div>

                <!-- Filter by Type -->
                <div>
                    <label for="filter-type" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <!-- Hidden input holds the value used by filtering logic -->
                    <input type="hidden" id="filter-type" value="all">
                    <!-- Custom select container -->
                    <div id="filter-type-select" class="relative"></div>
                </div>

                <!-- Filter by Person -->
                <div>
                    <label for="filter-person" class="block text-sm font-medium text-gray-700 mb-1">Person</label>
                    <input type="hidden" id="filter-person" value="all">
                    <div id="filter-person-select" class="relative"></div>
                </div>

                <!-- Date Range Filter (single input now, no col-span) -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                    <input
                        type="text"
                        id="filter-date-range"
                        placeholder="Select date range"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
                    >
                </div>

                <!-- Sort By -->
                <div>
                    <label for="sort-by" class="block text-sm font-medium text-gray-700 mb-1">Sort by</label>
                    <input type="hidden" id="sort-by" value="date-desc">
                    <div id="sort-by-select" class="relative"></div>
                </div>
            </div>
        </div>

        <!-- Expense Table / List -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-3">Purpose / Details</th>
                            <th scope="col" class="px-6 py-3 hidden md:table-cell">People</th>
                            <th scope="col" class="px-6 py-3 hidden lg:table-cell">Date</th>
                            <th scope="col" class="px-6 py-3 hidden sm:table-cell">Category</th>
                            <th scope="col" class="px-6 py-3 text-right">Amount</th>
                            <th scope="col" class="px-6 py-3 text-center">Receipts</th>
                        </tr>
                    </thead>
                    <tbody id="expense-table-body">
                        <!-- Rows will be populated by JS -->
                         <tr>
                            <td colspan="6" class="text-center p-8 text-gray-500">
                                Loading expenses...
                            </td>
                        </tr>
                    </tbody>
                    <tfoot class="bg-gray-100 font-semibold text-gray-900">
                        <tr>
                            <td class="px-6 py-4 text-right" colspan="4">Total Spending</td>
                            <td id="total-spending" class="px-6 py-4 text-right">à§³0</td>
                            <td class="px-6 py-4"></td>
                        </tr>
                    </tfoot>
                </table>
                 <div id="no-results" class="text-center py-12 text-gray-500 hidden">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                      <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h14a2 2 0 012 2V10a2 2 0 01-2 2H4a2 2 0 01-2-2z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No expenses found</h3>
                    <p class="mt-1 text-sm text-gray-500">Try adjusting your search or filter criteria.</p>
                  </div>
            </div>
        </div>
    </div>

    <!-- Receipt Viewer Modal -->
    <div id="receipt-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
        <div id="modal-content" class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-6 modal-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-900">Receipts</h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-800 transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="receipt-images-container" class="grid grid-cols-1 sm:grid-cols-1 gap-6">
                <!-- Receipt images will be populated by JS -->
            </div>
        </div>
    </div>

    <!-- Main JavaScript Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- GLOBAL STATE ---
            let expenses = [];

            // Default avatar (inline SVG as data URI) for missing person images
            const DEFAULT_AVATAR_DATA_URI = 'data:image/svg+xml;utf8,' + encodeURIComponent(
                `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#94a3b8">
                    <circle cx="12" cy="8" r="4"/>
                    <path d="M4 20c0-4 4-6 8-6s8 2 8 6v1H4v-1z"/>
                </svg>`
            );

            // --- BACKUP DATA ---
            const backupExpenses = [
                {
                    "id": 1, "purpose": "Team Lunch (Backup Data)", "amount": 151, "date": "2025-08-15", "type": "Food",
                    "comments": "Lunch meeting with the design team to discuss project milestones.",
                    "persons": ["Alice Johnson", "Charlie Brown"],
                    "receipts": [
                        { "url": "https://placehold.co/600x400/e2e8f0/475569?text=Receipt+1", "description": "Main course and drinks" },
                        { "url": "https://placehold.co/600x400/e2e8f0/475569?text=Receipt+2", "description": "Desserts and coffee" }
                    ]
                },
                {
                    "id": 2, "purpose": "Client Transport", "amount": 66, "date": "2025-08-14", "type": "Transport",
                    "comments": "Uber ride for client from airport to hotel.",
                    "persons": ["Bob Williams"],
                    "receipts": [
                        { "url": "https://placehold.co/600x400/e2e8f0/475569?text=Receipt+3", "description": "Uber trip receipt" }
                    ]
                },
                {
                    "id": 3, "purpose": "New Keyboard", "amount": 120, "date": "2025-08-12", "type": "Equipment",
                    "comments": "Mechanical keyboard for the lead developer.",
                    "persons": ["Charlie Brown"],
                    "receipts": []
                },
                {
                    "id": 4, "purpose": "Project Blueprints", "amount": 250, "date": "2025-08-10", "type": "Printing",
                    "comments": "Large format printing of architectural blueprints.",
                    "persons": ["Alice Johnson"],
                    "receipts": []
                },
                {
                    "id": 5, "purpose": "Software License", "amount": 300, "date": "2025-08-08", "type": "Software",
                    "comments": "Annual subscription for design software.",
                    "persons": ["David Miller"],
                    "receipts": []
                }
            ];

            // --- DOM ELEMENTS ---
            const tableBody = document.getElementById('expense-table-body');
            const totalSpendingEl = document.getElementById('total-spending');
            const searchInput = document.getElementById('search');
            const typeFilter = document.getElementById('filter-type');      // hidden input
            const personFilter = document.getElementById('filter-person');  // hidden input
            const dateRangeFilter = document.getElementById('filter-date-range');
            const sortSelect = document.getElementById('sort-by');          // hidden input

            // Custom select containers
            const typeSelectContainer = document.getElementById('filter-type-select');
            const personSelectContainer = document.getElementById('filter-person-select');
            const sortSelectContainer = document.getElementById('sort-by-select');

            const modal = document.getElementById('receipt-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const receiptImagesContainer = document.getElementById('receipt-images-container');
            const noResultsDiv = document.getElementById('no-results');

            /**
             * Fetches expense data from the external JSON file, with a fallback.
             */
            async function fetchExpenses() {
                try {
                    const response = await fetch('expenses.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    const data = await response.json();
                    expenses = data;
                    console.log("Successfully loaded expenses from expenses.json");
                    initializeApp();
                } catch (error) {
                    console.warn("Could not load expenses.json. Using backup data.", error);
                    expenses = backupExpenses;
                    initializeApp();
                }
            }

            /**
             * Initializes the application after data is ready.
             */
            function initializeApp() {
                // Build data lists
                const people = [...new Set(expenses.flatMap(e => e.persons))].sort();
                const categories = [...new Set(expenses.map(e => e.type))].sort();

                // Simple counts for nicer dropdown UX
                const personCounts = {};
                const categoryCounts = {};
                expenses.forEach(e => {
                    categoryCounts[e.type] = (categoryCounts[e.type] || 0) + 1;
                    e.persons.forEach(p => personCounts[p] = (personCounts[p] || 0) + 1);
                });

                // Render custom selects
                renderCategorySelect(categories, categoryCounts);
                renderPersonSelect(people, personCounts);
                renderSortSelect();

                // Initialize Flatpickr range picker
                if (window.flatpickr && dateRangeFilter) {
                    flatpickr(dateRangeFilter, {
                        mode: 'range',
                        dateFormat: 'Y-m-d',
                        allowInput: true,
                        onChange: (selectedDates) => {
                            const [start, end] = selectedDates;
                            dateRangeFilter.dataset.start = start ? formatDateISO(start) : '';
                            dateRangeFilter.dataset.end = end ? formatDateISO(end) : '';
                            // Trigger filtering
                            dateRangeFilter.dispatchEvent(new Event('change', { bubbles: true }));
                        },
                        onClose: (selectedDates, value) => {
                            if (!value) {
                                dateRangeFilter.dataset.start = '';
                                dateRangeFilter.dataset.end = '';
                                dateRangeFilter.dispatchEvent(new Event('change', { bubbles: true }));
                            }
                        }
                    });
                }

                // Initial render via filters to apply default sort
                applyFilters();

                // Event Listeners
                [searchInput, typeFilter, personFilter, dateRangeFilter, sortSelect].forEach(el => {
                    el.addEventListener('input', applyFilters);
                    el.addEventListener('change', applyFilters);
                });

                closeModalBtn.addEventListener('click', closeModal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) closeModal();
                });

                // Close dropdowns on outside click or Escape
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.custom-select')) closeAllDropdowns();
                });
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') closeAllDropdowns();
                });
            }

            /**
             * Build a reusable custom select.
             * options: [{ value, label, dotClass?, count?, avatarClass?, initials?, imageUrl? }]
             */
            function buildCustomSelect(container, hiddenInput, options, config = {}) {
                container.classList.add('custom-select', 'relative');
                container.innerHTML = '';

                let selected = options.find(o => o.value === hiddenInput.value) || options[0];

                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'w-full px-3 py-2 border border-gray-300 rounded-lg bg-white text-left flex items-center justify-between hover:border-indigo-400 focus:ring-2 focus:ring-indigo-500 transition';
                button.setAttribute('aria-haspopup', 'listbox');

                const leftWrap = document.createElement('span');
                leftWrap.className = 'flex items-center truncate';

                // Prefix in button (dot / avatar / image / icon)
                const prefix = document.createElement('span');
                prefix.setAttribute('data-prefix', '');
                prefix.className = 'mr-2 flex items-center shrink-0';
                leftWrap.appendChild(prefix);

                const labelSpan = document.createElement('span');
                labelSpan.className = 'truncate';
                labelSpan.textContent = selected.label;
                leftWrap.appendChild(labelSpan);

                const chevron = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                chevron.setAttribute('viewBox', '0 0 20 20');
                chevron.setAttribute('fill', 'currentColor');
                chevron.setAttribute('data-chevron', '1');
                chevron.classList.add('w-5', 'h-5', 'text-gray-500', 'ml-3', 'shrink-0', 'transition-transform', 'duration-200');
                chevron.innerHTML = '<path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 111.06 1.06l-4.24 4.24a.75.75 0 01-1.06 0L5.21 8.29a.75.75 0 01.02-1.08z" clip-rule="evenodd" />';
                button.appendChild(leftWrap);
                button.appendChild(chevron);

                const menu = document.createElement('div');
                menu.className = 'absolute z-30 mt-2 w-full bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden hidden';
                const list = document.createElement('ul');
                list.className = 'max-h-64 overflow-auto py-1';

                // Helpers to render visuals
                function renderDot(dotClass) {
                    const dot = document.createElement('span');
                    dot.className = `inline-block w-2.5 h-2.5 rounded-full ${dotClass}`;
                    return dot;
                }
                function renderAvatar(initials, avatarClass) {
                    const av = document.createElement('span');
                    av.className = `inline-flex items-center justify-center w-5 h-5 rounded-full text-[10px] font-semibold text-white ${avatarClass}`;
                    av.textContent = initials || '';
                    return av;
                }
                function renderPersonImageOrAvatar(opt) {
                    // Single <img> with guarded fallbacks; final fallback to initials avatar.
                    const wrap = document.createElement('span');
                    wrap.className = 'inline-flex items-center';

                    const avatarFallback = renderAvatar(opt.initials, opt.avatarClass || 'bg-gray-400');
                    avatarFallback.classList.add('hidden');

                    const img = document.createElement('img');
                    img.alt = opt.label;
                    img.className = 'w-5 h-5 rounded-full object-cover';
                    img.src = opt.imageUrl || DEFAULT_AVATAR_DATA_URI;

                    let triedDefault = false;
                    img.onerror = () => {
                        if (!triedDefault) {
                            triedDefault = true;
                            img.src = DEFAULT_AVATAR_DATA_URI;
                        } else {
                            img.classList.add('hidden');
                            avatarFallback.classList.remove('hidden');
                        }
                    };

                    wrap.appendChild(img);
                    wrap.appendChild(avatarFallback);
                    return wrap;
                }
                function renderSortIcon(value) {
                    // small left icon for sort options
                    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    svg.setAttribute('viewBox', '0 0 20 20');
                    svg.setAttribute('fill', 'currentColor');
                    svg.classList.add('w-4', 'h-4', 'text-gray-500', 'mr-2', 'shrink-0');
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const map = {
                        'date-desc': 'M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zM2 9h16v7a2 2 0 01-2 2H4a2 2 0 01-2-2V9zm6 2a1 1 0 000 2h4a1 1 0 100-2H8z', // calendar with bar
                        'date-asc':  'M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zM2 9h16v7a2 2 0 01-2 2H4a2 2 0 01-2-2V9zm3 7l3-3 3 3H5z', // calendar with up caret
                        'amount-desc': 'M10 2a1 1 0 01.993.883L11 3v1.055c1.928.256 3.5 1.39 3.5 3.195 0 1.735-1.206 2.61-3.07 3.095l-.43.11V14h3.5a1 1 0 010 2H11v1a1 1 0 01-2 0v-1H6.5a1 1 0 010-2H9v-3.137l-.298-.07C6.89 10.23 5.5 9.319 5.5 7.25c0-1.806 1.572-2.94 3.5-3.196V3a1 1 0 011-1z', // currency-like
                        'amount-asc':  'M3 16a1 1 0 011-1h5v-2H7a1 1 0 110-2h2V9H6a1 1 0 110-2h3V5a1 1 0 112 0v2h3a1 1 0 110 2h-3v2h2a1 1 0 110 2h-2v2h5a1 1 0 110 2H4a1 1 0 01-1-1z',
                        'purpose-asc': 'M4 6a2 2 0 012-2h8a2 2 0 012 2v1H4V6zm0 3h12v5a2 2 0 01-2 2H6a2 2 0 01-2-2V9zm2 2v3h8v-3H6z', // A-Z folder-ish
                        'purpose-desc':'M4 5a2 2 0 012-2h5a2 2 0 012 2v1H4V5zm0 3h13v6a2 2 0 01-2 2H6a2 2 0 01-2-2V8zm2 2v4h9v-4H6z'  // Z-A folder-ish
                    };
                    path.setAttribute('d', map[value] || map['date-desc']);
                    svg.appendChild(path);
                    return svg;
                }

                function setButtonPrefix(opt) {
                    prefix.innerHTML = '';
                    if (config.showDots && opt.dotClass) {
                        const dot = renderDot(opt.dotClass);
                        dot.classList.add('mr-0'); // spacing already handled by prefix container
                        prefix.appendChild(dot);
                    } else if (config.showAvatar) {
                        prefix.appendChild(renderPersonImageOrAvatar(opt));
                    } else if (config.getIcon) {
                        prefix.appendChild(config.getIcon(opt.value));
                    }
                }
                setButtonPrefix(selected);

                options.forEach(opt => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center justify-between px-3 py-2 cursor-pointer hover:bg-gray-50';
                    li.setAttribute('role', 'option');
                    li.dataset.value = opt.value;

                    const left = document.createElement('div');
                    left.className = 'flex items-center min-w-0';

                    // Left visuals (priority: dot -> avatar/image -> icon)
                    if (config.showDots && opt.dotClass) {
                        const dotWrap = document.createElement('span');
                        dotWrap.className = 'mr-2';
                        dotWrap.appendChild(renderDot(opt.dotClass));
                        left.appendChild(dotWrap);
                    } else if (config.showAvatar) {
                        const avWrap = document.createElement('span');
                        avWrap.className = 'mr-2';
                        avWrap.appendChild(renderPersonImageOrAvatar(opt));
                        left.appendChild(avWrap);
                    } else if (config.getIcon) {
                        left.appendChild(renderSortIcon(opt.value));
                    }

                    const text = document.createElement('span');
                    text.className = 'truncate text-gray-700';
                    text.textContent = opt.label;
                    left.appendChild(text);

                    const right = document.createElement('div');
                    right.className = 'flex items-center space-x-2';

                    if (typeof opt.count === 'number') {
                        const cnt = document.createElement('span');
                        cnt.className = 'text-xs text-gray-400';
                        cnt.textContent = opt.count;
                        right.appendChild(cnt);
                    }

                    if (opt.value === selected.value) {
                        const check = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                        check.setAttribute('viewBox', '0 0 20 20');
                        check.setAttribute('fill', 'currentColor');
                        check.setAttribute('data-check', '1');
                        check.classList.add('w-4', 'h-4', 'text-indigo-600');
                        check.innerHTML = '<path fill-rule="evenodd" d="M16.704 5.29a1 1 0 010 1.415l-7.07 7.07a1 1 0 01-1.415 0L3.296 9.85A1 1 0 114.71 8.435l3.092 3.092 6.363-6.363a1 1 0 011.415 0z" clip-rule="evenodd"/>';
                        right.appendChild(check);
                        li.classList.add('bg-indigo-50');
                    }

                    li.appendChild(left);
                    li.appendChild(right);

                    li.addEventListener('click', () => {
                        // Update selection state visuals (fixes checkmark bug)
                        list.querySelectorAll('li').forEach(el => {
                            el.classList.remove('bg-indigo-50');
                            const chk = el.querySelector('[data-check]');
                            if (chk) chk.remove();
                        });
                        const newCheck = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                        newCheck.setAttribute('viewBox', '0 0 20 20');
                        newCheck.setAttribute('fill', 'currentColor');
                        newCheck.setAttribute('data-check', '1');
                        newCheck.classList.add('w-4', 'h-4', 'text-indigo-600');
                        newCheck.innerHTML = '<path fill-rule="evenodd" d="M16.704 5.29a1 1 0 010 1.415l-7.07 7.07a1 1 0 01-1.415 0L3.296 9.85A1 1 0 114.71 8.435l3.092 3.092 6.363-6.363a1 1 0 011.415 0z" clip-rule="evenodd"/>';
                        li.querySelector('div.flex.items-center.space-x-2')?.appendChild(newCheck);
                        li.classList.add('bg-indigo-50');

                        // Update selected value
                        selected = opt;
                        hiddenInput.value = opt.value;

                        // Update button visuals
                        labelSpan.textContent = opt.label;
                        setButtonPrefix(opt);

                        // Close and notify
                        menu.classList.add('hidden');
                        chevron.classList.remove('rotate-180');
                        hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
                    });

                    list.appendChild(li);
                });

                menu.appendChild(list);

                button.addEventListener('click', () => {
                    const isOpen = !menu.classList.contains('hidden');
                    closeAllDropdowns();
                    if (!isOpen) {
                        menu.classList.remove('hidden');
                        chevron.classList.add('rotate-180');
                    }
                });

                container.appendChild(button);
                container.appendChild(menu);
            }

            function closeAllDropdowns() {
                document.querySelectorAll('.custom-select .absolute').forEach(m => m.classList.add('hidden'));
                // Only rotate chevrons, not checkmarks
                document.querySelectorAll('.custom-select [data-chevron]').forEach(s => s.classList.remove('rotate-180'));
            }

            // Category colored dot: stable mapping from category text to Tailwind bg-* color
            function getCategoryDotColor(category) {
                const dots = [
                    'bg-blue-500','bg-purple-500','bg-yellow-500','bg-pink-500',
                    'bg-indigo-500','bg-red-500','bg-green-500','bg-amber-500'
                ];
                let hash = 0;
                for (let i = 0; i < category.length; i++) {
                    hash = category.charCodeAt(i) + ((hash << 5) - hash);
                }
                return dots[Math.abs(hash % dots.length)];
            }

            // Add: sanitize a name to a safe filename (spaces -> underscores, strip/underscore unsafe)
            function sanitizeForFilename(name) {
                return name
                    .trim()
                    .replace(/\s+/g, '_')          // spaces -> underscores
                    .replace(/[^A-Za-z0-9_-]/g, '_') // non-safe chars -> underscore
                    .replace(/_+/g, '_');          // collapse multiple underscores
            }

            // Small pastel badge for table remains as-is
            function getCategoryColor(category) {
                const colors = [
                    "bg-blue-100 text-blue-800", "bg-purple-100 text-purple-800",
                    "bg-yellow-100 text-yellow-800", "bg-purple-100 text-purple-800",
                    "bg-pink-100 text-pink-800", "bg-indigo-100 text-indigo-800",
                    "bg-red-100 text-red-800", "bg-green-100 text-green-800"
                ];
                let hash = 0;
                for (let i = 0; i < category.length; i++) {
                    hash = category.charCodeAt(i) + ((hash << 5) - hash);
                }
                const index = Math.abs(hash % colors.length);
                return colors[index];
            }

            function renderCategorySelect(categories, categoryCounts) {
                const opts = [
                    { value: 'all', label: 'All Categories', dotClass: 'bg-gray-400', count: expenses.length },
                    ...categories.map(c => ({
                        value: c,
                        label: c,
                        dotClass: getCategoryDotColor(c),
                        count: categoryCounts[c] || 0
                    }))
                ];
                buildCustomSelect(typeSelectContainer, typeFilter, opts, { showDots: true });
            }

            function renderPersonSelect(people, personCounts) {
                // Try to load ./people/{sanitized_name}.jpg. Fallback to default icon (then initials).
                const avatarColors = ['bg-indigo-500','bg-emerald-500','bg-rose-500','bg-sky-500','bg-amber-500','bg-violet-500','bg-cyan-500','bg-fuchsia-500'];
                const opts = [
                    { value: 'all', label: 'All People', count: expenses.length, avatarClass: 'bg-gray-400', initials: '*' }
                    ,
                    ...people.map(p => {
                        let hash = 0; for (let i = 0; i < p.length; i++) hash = p.charCodeAt(i) + ((hash << 5) - hash);
                        const avatarClass = avatarColors[Math.abs(hash % avatarColors.length)];
                        const initials = p.split(' ').map(s => s[0]).join('').slice(0,2).toUpperCase();
                        const imageUrl = `./people/${sanitizeForFilename(p)}.jpg`;
                        return { value: p, label: p, count: personCounts[p] || 0, avatarClass, initials, imageUrl };
                    })
                ];
                buildCustomSelect(personSelectContainer, personFilter, opts, { showAvatar: true });
            }

            function renderSortSelect() {
                const opts = [
                    { value: 'date-desc',   label: 'Date (Newest)' },
                    { value: 'date-asc',    label: 'Date (Oldest)' },
                    { value: 'amount-desc', label: 'Amount (High â Low)' },
                    { value: 'amount-asc',  label: 'Amount (Low â High)' },
                    { value: 'purpose-asc', label: 'Purpose (A â Z)' },
                    { value: 'purpose-desc',label: 'Purpose (Z â A)' }
                ];
                buildCustomSelect(sortSelectContainer, sortSelect, opts, {
                    getIcon: (value) => {
                        // Reuse the renderer defined inside build via a lightweight proxy
                        const tmp = document.createElementNS('http://www.w3.org/2000/svg', 'svg'); // placeholder
                        // We can't access inner function here; reconstruct icon similarly:
                        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                        svg.setAttribute('viewBox', '0 0 20 20');
                        svg.setAttribute('fill', 'currentColor');
                        svg.classList.add('w-4', 'h-4', 'text-gray-500', 'mr-2', 'shrink-0');
                        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        const map = {
                            'date-desc': 'M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zM2 9h16v7a2 2 0 01-2 2H4a2 2 0 01-2-2V9zm6 2a1 1 0 000 2h4a1 1 0 100-2H8z',
                            'date-asc':  'M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zM2 9h16v7a2 2 0 01-2 2H4a2 2 0 01-2-2V9zm3 7l3-3 3 3H5z',
                            'amount-desc': 'M10 2a1 1 0 01.993.883L11 3v1.055c1.928.256 3.5 1.39 3.5 3.195 0 1.735-1.206 2.61-3.07 3.095l-.43.11V14h3.5a1 1 0 010 2H11v1a1 1 0 01-2 0v-1H6.5a1 1 0 010-2H9v-3.137l-.298-.07C6.89 10.23 5.5 9.319 5.5 7.25c0-1.806 1.572-2.94 3.5-3.196V3a1 1 0 011-1z',
                            'amount-asc':  'M3 16a1 1 0 011-1h5v-2H7a1 1 0 110-2h2V9H6a1 1 0 110-2h3V5a1 1 0 112 0v2h3a1 1 0 110 2h-3v2h2a1 1 0 110 2h-2v2h5a1 1 0 110 2H4a1 1 0 01-1-1z',
                            'purpose-asc': 'M4 6a2 2 0 012-2h8a2 2 0 012 2v1H4V6zm0 3h12v5a2 2 0 01-2 2H6a2 2 0 01-2-2V9zm2 2v3h8v-3H6z',
                            'purpose-desc':'M4 5a2 2 0 012-2h5a2 2 0 012 2v1H4V5zm0 3h13v6a2 2 0 01-2 2H6a2 2 0 01-2-2V8zm2 2v4h9v-4H6z'
                        };
                        path.setAttribute('d', map[value] || map['date-desc']);
                        svg.appendChild(path);
                        return svg;
                    }
                });
            }

            // Helper: render tiny avatar chips with name for the People column
            function generatePeopleChipsHTML(persons) {
                return persons.map(name => {
                    const imgUrl = `./people/${sanitizeForFilename(name)}.jpg`;
                    return `
                        <span class="inline-flex items-center bg-gray-50 border border-gray-200 rounded-full px-2 py-0.5">
                            <img src="${imgUrl}" alt="${name}" class="w-4 h-4 rounded-full object-cover mr-1 ring-1 ring-white"
                                 onerror="if(!this.dataset.fbk){this.dataset.fbk=1;this.src='${DEFAULT_AVATAR_DATA_URI}'}" />
                            <span class="text-xs text-gray-700">${name}</span>
                        </span>
                    `;
                }).join('');
            }

            /**
             * Applies all active filters and re-renders the table.
             */
            function applyFilters() {
                let filteredExpenses = [...expenses];
                const searchTerm = searchInput.value.toLowerCase().trim();
                const type = typeFilter.value;
                const person = personFilter.value;
                let startDate = dateRangeFilter?.dataset.start || '';
                let endDate = dateRangeFilter?.dataset.end || '';
                if ((!startDate || !endDate) && dateRangeFilter?.value?.includes('to')) {
                    const parts = dateRangeFilter.value.split('to').map(s => s.trim());
                    startDate = parts[0] || '';
                    endDate = parts[1] || '';
                }
                const sort = sortSelect.value;

                if (searchTerm) {
                    filteredExpenses = filteredExpenses.filter(e =>
                        e.purpose.toLowerCase().includes(searchTerm) ||
                        e.comments.toLowerCase().includes(searchTerm)
                    );
                }
                if (type !== 'all') {
                    filteredExpenses = filteredExpenses.filter(e => e.type === type);
                }
                if (person !== 'all') {
                    filteredExpenses = filteredExpenses.filter(e => e.persons.includes(person));
                }
                if (startDate) {
                    filteredExpenses = filteredExpenses.filter(e => e.date >= startDate);
                }
                if (endDate) {
                    filteredExpenses = filteredExpenses.filter(e => e.date <= endDate);
                }

                // Sort
                filteredExpenses.sort((a, b) => {
                    switch (sort) {
                        case 'date-asc':
                            return new Date(a.date) - new Date(b.date);
                        case 'date-desc':
                            return new Date(b.date) - new Date(a.date);
                        case 'amount-asc':
                            return a.amount - b.amount;
                        case 'amount-desc':
                            return b.amount - a.amount;
                        case 'purpose-asc':
                            return a.purpose.localeCompare(b.purpose);
                        case 'purpose-desc':
                            return b.purpose.localeCompare(a.purpose);
                        default:
                            return 0;
                    }
                });

                renderTable(filteredExpenses);
            }

            /**
             * Renders the expense data into the table.
             */
            function renderTable(data) {
                tableBody.innerHTML = '';

                if (data.length === 0) {
                    noResultsDiv.classList.remove('hidden');
                    totalSpendingEl.textContent = formatCurrency(0);
                    return;
                }

                noResultsDiv.classList.add('hidden');

                let total = 0;
                data.forEach(expense => {
                    total += expense.amount;
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50';

                    const badgeClass = getCategoryColor(expense.type);

                    row.innerHTML = `
                        <td class="px-6 py-4">
                            <div class="font-semibold text-gray-900">${expense.purpose}</div>
                            <div class="text-xs text-gray-500">${expense.comments}</div>
                            <div class="mt-2 text-xs text-gray-500 md:hidden">
                                <span>${expense.persons.join(', ')}</span> &bull; <span>${formatDate(expense.date)}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 hidden md:table-cell">
                            <div class="flex flex-wrap gap-1">
                                ${generatePeopleChipsHTML(expense.persons)}
                            </div>
                        </td>
                        <td class="px-6 py-4 hidden lg:table-cell">${formatDate(expense.date)}</td>
                        <td class="px-6 py-4 hidden sm:table-cell">
                            <span class="px-2 py-1 text-xs font-medium rounded-full ${badgeClass}">
                                ${expense.type}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right font-medium text-gray-900">${formatCurrency(expense.amount)}</td>
                        <td class="px-6 py-4 text-center">
                            ${expense.receipts.length > 0 ? `
                            <button data-receipts='${JSON.stringify(expense.receipts)}' class="view-receipt-btn font-medium text-indigo-600 hover:text-indigo-800 transition">
                                View (${expense.receipts.length})
                            </button>
                            ` : `<span class="text-gray-400 text-xs">None</span>`}
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                totalSpendingEl.textContent = formatCurrency(total);

                document.querySelectorAll('.view-receipt-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const receipts = JSON.parse(e.currentTarget.dataset.receipts);
                        openModal(receipts);
                    });
                });
            }

            /**
             * Opens and populates the receipt modal with descriptions.
             */
            function openModal(receipts) {
                receiptImagesContainer.innerHTML = '';
                receipts.forEach((receipt, index) => {
                    const receiptEl = document.createElement('div');
                    receiptEl.className = 'group relative text-center';
                    receiptEl.innerHTML = `
                        <div class="relative inline-block">
                            <img src="${receipt.url}" alt="Receipt ${index + 1}" class="rounded-lg w-full h-auto object-cover max-w-xs mx-auto" onerror="this.onerror=null;this.src='https://placehold.co/600x400/fecaca/b91c1c?text=Image+Error';">
                            <a href="${receipt.url}" download="receipt-${index + 1}.jpg" class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-xs px-3 py-1.5 rounded-full hover:bg-opacity-75 transition opacity-0 group-hover:opacity-100 flex items-center">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                Download
                            </a>
                        </div>
                        <p class="text-sm text-gray-600 mt-2">${receipt.description || 'No description'}</p>
                    `;
                    receiptImagesContainer.appendChild(receiptEl);
                });
                modal.classList.remove('hidden');
            }

            function closeModal() {
                modal.classList.add('hidden');
            }

            /**
             * Dynamically assigns a color badge to a category.
             * @param {string} category - The category name.
             * @returns {string} Tailwind CSS classes for the badge.
             */
            function getCategoryColor(category) {
                const colors = [
                    "bg-blue-100 text-blue-800", "bg-purple-100 text-purple-800",
                    "bg-yellow-100 text-yellow-800", "bg-purple-100 text-purple-800",
                    "bg-pink-100 text-pink-800", "bg-indigo-100 text-indigo-800",
                    "bg-red-100 text-red-800", "bg-green-100 text-green-800"
                ];
                let hash = 0;
                for (let i = 0; i < category.length; i++) {
                    hash = category.charCodeAt(i) + ((hash << 5) - hash);
                }
                const index = Math.abs(hash % colors.length);
                return colors[index];
            }

            /**
             * Formats a number as BDT currency, rounded to the nearest whole number.
             */
            function formatCurrency(amount) {
                const roundedAmount = Math.round(amount);
                return new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'BDT',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0,
                }).format(roundedAmount).replace('BDT', 'à§³');
            }

            function formatDate(dateString) {
                const date = new Date(dateString + 'T00:00:00');
                return new Intl.DateTimeFormat('en-GB', { month: 'short', day: 'numeric', year: 'numeric' }).format(date);
            }

            // Helper: ISO format for Date object (YYYY-MM-DD)
            function formatDateISO(dateObj) {
                const y = dateObj.getFullYear();
                const m = String(dateObj.getMonth() + 1).padStart(2, '0');
                const d = String(dateObj.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            }

            // --- START THE APP ---
            fetchExpenses();
        });
    </script>

</body>
</html>
